<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HubGPT Chat Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold mb-4">HubGPT Chat Test</h1>
            
            <!-- Advisor Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Advisor</label>
                <select id="advisor" class="w-full p-2 border rounded-md">
                    <option value="jim_collins">Jim Collins</option>
                </select>
            </div>

            <!-- Chat History -->
            <div id="chat-history" class="mb-4 h-96 overflow-y-auto border rounded-md p-4 bg-gray-50">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Message Input -->
            <div class="flex gap-2">
                <input type="text" id="message" 
                    class="flex-1 p-2 border rounded-md"
                    placeholder="Type your message...">
                <button onclick="sendMessage()" 
                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                    Send
                </button>
            </div>

            <!-- Debug Info -->
            <div class="mt-4">
                <div class="flex items-center gap-2 mb-2">
                    <label class="text-sm font-medium text-gray-700">Chat ID:</label>
                    <span id="chat-id" class="text-sm text-gray-500">None</span>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Message Count:</label>
                    <span id="message-count" class="text-sm text-gray-500">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = null;
        let messageCount = 0;

        // Fetch advisors on page load
        async function loadAdvisors() {
            try {
                const response = await fetch('/advisors');
                const advisors = await response.json();
                const select = document.getElementById('advisor');
                select.innerHTML = advisors
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .map(advisor => `<option value="${advisor.name}">${advisor.name.replace(/_/g, ' ')}</option>`)
                    .join('');
            } catch (error) {
                console.error('Error loading advisors:', error);
            }
        }

        // Load advisors when page loads
        loadAdvisors();

        // Handle enter key in message input
        document.getElementById('message').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function appendMessage(role, content) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${role === 'user' ? 'text-right' : ''}`;
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user' 
                ? 'inline-block bg-blue-500 text-white px-4 py-2 rounded-lg max-w-[80%]'
                : 'inline-block bg-gray-200 text-gray-800 px-4 py-2 rounded-lg max-w-[80%]';
            bubble.textContent = content;
            
            messageDiv.appendChild(bubble);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Update message count
            messageCount++;
            document.getElementById('message-count').textContent = messageCount;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message');
            const message = messageInput.value.trim();
            const advisor = document.getElementById('advisor').value;
            
            if (!message) return;
            
            // Clear input
            messageInput.value = '';
            
            // Add user message to chat
            appendMessage('user', message);
            
            try {
                // Prepare request body
                const body = {
                    message: message
                };
                if (currentChatId) {
                    body.chat_id = currentChatId;
                }
                
                // Make API call
                const response = await fetch(`/chat/${advisor}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify(body)
                });
                
                // Get chat ID from response headers
                const chatId = response.headers.get('X-Chat-ID');
                if (chatId) {
                    currentChatId = chatId;
                    document.getElementById('chat-id').textContent = chatId;
                }
                
                // Create initial assistant message container
                const messageDiv = document.createElement('div');
                messageDiv.className = 'mb-4';
                messageDiv.innerHTML = `
                    <div id="assistant-response" class="inline-block bg-gray-200 text-gray-800 px-4 py-2 rounded-lg max-w-[80%]">
                        <span class="typing-indicator">▌</span>
                    </div>
                `;
                document.getElementById('chat-history').appendChild(messageDiv);
                
                let responseText = '';
                const assistantMessage = document.getElementById('assistant-response');

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6); // Remove 'data: ' prefix
                            console.log('Received chunk:', data);
                            
                            // Skip debug info
                            if (data.includes('"advisor":')) {
                                console.log('Debug info:', data);
                                continue;
                            }
                            
                            // Update response text
                            responseText += data;
                            if (assistantMessage) {
                                assistantMessage.innerHTML = responseText + '<span class="typing-indicator">▌</span>';
                                
                                // Scroll to bottom
                                const chatHistory = document.getElementById('chat-history');
                                chatHistory.scrollTop = chatHistory.scrollHeight;
                            }
                        }
                    }
                }
                
                // Remove typing indicator when done
                if (assistantMessage) {
                    assistantMessage.innerHTML = responseText;
                    assistantMessage.removeAttribute('id');
                }
                
            } catch (error) {
                console.error('Error:', error);
                appendMessage('assistant', 'Error: Failed to get response');
            }
        }

        // Add CSS for typing indicator animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0; }
                100% { opacity: 1; }
            }
            .typing-indicator {
                animation: blink 1s infinite;
                margin-left: 2px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html> 